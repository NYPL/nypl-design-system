import { ArgsTable, Canvas, Meta, Story } from "@storybook/addon-docs";
import { withDesign } from "storybook-addon-designs";

import Header from "./Header";
import { getCategory } from "../../utils/componentCategories";

<Meta
  title={getCategory("Header")}
  parameters={{ layout: "fullscreen" }}
  component={Header}
  decorators={[withDesign]}
/>

# Header

| Component Version | DS Version |
| ----------------- | ---------- |
| Added             | `TBD`      |
| Latest            | `TBD`      |

## Table of Contents

- [Overview](#overview)
- [Component Props](#component-props)
- [Accessibility](#accessibility)
- [Login](#login)
- [Google Analytics](#google-analytics)

## Overview

<Description of={Header} />

The `Header` component is meant to replicate (and eventually replace) the current
[NYPL Header package](https://github.com/NYPL/dgx-header-component/) which is used
across various NYPL products, with Design System technologies and components. It
is a work in progress, and not yet ready for use. What you see below is simply a
static component with no functionality.

## Component Props

<Canvas withToolbar>
  <Story name="Header">
    <Header />
  </Story>
</Canvas>

<ArgsTable story="Header" />

## Accessibility

The `Header` uses react-focus-lock to trap (or loop) focus within its various dropdowns:
the login submenu, the search form, and the mobile navigation submenu. This is to
make keyboard navigation easier for users. Trapping focus means that when a parent
element is clicked and its dropdown becomes visible, focus remains among its children
while the user tabs. The user may close the dropdown and escape the focus trap by clicking
on the parent element once again.

This is how the original NYPL `Header` was implemented and its Reservoir counterpart
replicates this behavior. However, this is not the _currently recommended_ way to
implement focus management in dropdowns. According to the W3C, right and left arrow
keys, rather than tab, should loop focus over child elements. Tabbing should instead
close the dropdown and move focus to the following parent. In the future, we hope to
change the Reservoir Header to align with current best practices.

## Login

While the `Header` doesn't perform authentication, it does determine whether a user is
logged in and, if they are, renders a logged in UI, which includes the patron's name.

This process begins after the `Header` mounts. At that time, it looks for the
`nyplIdentityPatron` cookie. If it exists, an `accessToken` is extracted from the cookie
and sent via fetch request to the `patronApiUrl`. If the request is successful, the
patron's name is returned. The name is then stored in a React Context variable called
`HeaderContext`, which is available to all children of the `Header`. The existance of the
patron's name in `HeaderContext` causes the `HeaderLoginButton` and `HeaderLogin` to
render their "logged in" view.

There is the possibility that the call to the `patronApiUrl` returns a response with a
`statusCode` of 401 and an `expired` key set to true. This means the `accessToken` is
expired. If this is the case, the `Header` will attempt to refresh the `accessToken` by
sending a fetch request to the `tokenRefreshLink`. If successful, the `Header` will retry
the request to the `patronApiUrl` with the new `accessToken`.

## Google Analytics

Google will sunset Google Analytics (GA) in 2023, but the current NYPL Header
uses GA and therefore the Reservoir `Header` component will continue to use GA
until GA is sunset.

The `Header` component takes two props that are used to configure GA:

- `isProduction`: a boolean that determines whether the `Header` is in
  production mode or not. If `true`, the production GA code is set and the
  `testMode` status for unit testing is set to `false`; if `false`, the
  development GA code is set and the `testMode` is set to `true`. Set to `true`
  by default.
- `gaOptions`: an object that contains the GA settings.
  - `debug`: a boolean that determines whether to log GA debug messages to the
    console. `false` by default.
  - `standardImplementation`: a boolean to initialize GA with the standard
    implementation. This is `false` by default, but if your app uses the
    standard initialize GA code that is set in the HTML body element, then
    set this to `true`.
  - `titleCase`: a boolean that determines whether to use title case for the
    GA page title. By default, this is set to the opposite value of
    `isProduction`. For example, when `isProduction` is `true`, then `titleCase`
    is `false`. Since `isProduction` is `true` by default, `titleCase` is
    `false` by default.
  - `testMode`: a boolean that determines whether to set GA to test mode to use
    its special API for unit testing GA calls through the `testModeAPI`
    property. `false` by default but set to `true` when running unit tests.
